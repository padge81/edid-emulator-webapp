<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EDID Management</title>

<style>
body {
    font-family: Arial, sans-serif;
    margin: 20px;
}
select, input, button {
    margin: 6px 0;
    width: 320px;
}
textarea {
    width: 100%;
    height: 220px;
    font-family: monospace;
}
#status {
    margin-top: 10px;
    padding: 8px;
    border: 1px solid #ccc;
    background: #f8f8f8;
}
</style>
</head>

<body>

<h2>EDID Files Management</h2>

<select id="files"></select>
<button onclick="loadFile()">Load & Preview</button>

<textarea id="preview" readonly></textarea>

<button onclick="writeEdid()">Write EDID</button>
<button onclick="verifyEdid()">Verify EDID</button>

<h3>Repository</h3>
<input type="password" id="passcode" placeholder="Optional passcode">
<button onclick="updateRepo()">Update Repository</button>

<div id="status"></div>

<p>Version: {{ version }}</p>

<script>
const statusBox = document.getElementById("status");

function setStatus(msg) {
    statusBox.textContent = msg;
}

function loadFiles() {
    fetch("/list_files")
        .then(r => r.json())
        .then(d => {
            const sel = document.getElementById("files");
            sel.innerHTML = "";
            d.files.forEach(f => {
                const o = document.createElement("option");
                o.value = f;
                o.textContent = f;
                sel.appendChild(o);
            });
        });
}

function loadFile() {
    const file = document.getElementById("files").value;
    if (!file) return setStatus("Select a file first");

    fetch(`/read_edid_file?filename=${encodeURIComponent(file)}`)
        .then(r => r.json())
        .then(d => {
            if (d.error) return setStatus(d.error);

            const bin = atob(d.edid_content);
            let hex = "";
            for (let i = 0; i < bin.length; i++) {
                hex += bin.charCodeAt(i).toString(16).padStart(2, "0") + " ";
                if ((i + 1) % 16 === 0) hex += "\n";
            }
            document.getElementById("preview").value = hex;
            setStatus("Loaded " + file);
        });
}

function writeEdid() {
    const file = document.getElementById("files").value;
    if (!file) return setStatus("Select a file first");

    fetch("/write_edid_from_file", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ filename: file, port: "2" })
    })
    .then(r => r.json())
    .then(d => setStatus(d.message || d.error));
}

function verifyEdid() {
    const file = document.getElementById("files").value;
    if (!file) return setStatus("Select a file first");

    fetch("/verify_edid", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ filename: file, port: "2" })
    })
    .then(r => r.json())
    .then(d => {
        setStatus(d.match ? "Verification successful" : "Verification failed");
    });
}

function updateRepo() {
    fetch("/update_repo", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ passcode: document.getElementById("passcode").value })
    })
    .then(r => r.json())
    .then(d => setStatus(d.message || d.error));
}

loadFiles();
</script>

</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <title>EDID Emulator</title>
    <style>
        body { font-family: Arial; max-width: 960px; margin: auto; }
        textarea { width: 90%; height: 200px; }
        button, select, input { margin: 5px 5px 5px 0; }
        pre { background: #111; color: #0f0; padding: 10px; overflow-x: auto; }
        .space-around { padding-left: 20px; }
        .status { padding: 8px; font-weight: bold; border-radius: 4px; }
        .idle { background: #eee; }
        .working { background: #ffeaa7; }
        .success { background: #55efc4; }
        .warning { background: #fab1a0; }
        .error { background: #ff7675; }
        .container { padding: 0 30px; }
    </style>
</head>
<body>

<div style="display:flex; justify-content:space-between;">
    <div>Version: <b id="version">loading…</b></div>
</div>

<div class="space-around">
    <button onclick="updateRepo()">Update</button>
</div>

<hr>

<div class="space-around">
<h2>EDID Emulator</h2>

<label>I²C Port:</label>
<select id="portSelect">
    {% for p in ports %}
        <option value="{{ p }}" {% if p == default_port %}selected{% endif %}>{{ p }}</option>
    {% endfor %}
</select>
</div>

<hr>

<div class="container">
    <button onclick="readEdid()">Read EDID</button>
    <button onclick="resetEdid()">Reset</button>
    <button id="toggleView" onclick="toggleView()" disabled>View: Binary</button>
</div>

<div class="space-around">
    <p>Match: <b id="matchResult">—</b></p>
</div>

<div class="container">
    <textarea id="preview" readonly></textarea>
</div>

<div class="space-around">
<h3>Save New EDID</h3>
<input id="saveName" placeholder="filename.bin" disabled>
<button id="saveBtn" onclick="saveEdid()" disabled>Save</button>

<h3>Write EDID</h3>
<select id="writeSelect">
    <option value="">-- select --</option>
    {% for f in files %}
        <option value="{{ f }}">{{ f }}</option>
    {% endfor %}
</select>
<button onclick="confirmWrite()">Write</button>

<h3>Status</h3>
</div>

<div id="status" class="status idle">Idle</div>

<div id="diffBlock" style="display:none;">
    <h3>Verification Diff</h3>
    <pre id="diff"></pre>
</div>

<script>
const el = {};

window.addEventListener("DOMContentLoaded", () => {
    el.status = document.getElementById("status");
    el.preview = document.getElementById("preview");
    el.matchResult = document.getElementById("matchResult");
    el.toggleView = document.getElementById("toggleView");
    el.saveBtn = document.getElementById("saveBtn");
    el.saveName = document.getElementById("saveName");
    el.writeSelect = document.getElementById("writeSelect");
    el.portSelect = document.getElementById("portSelect");
    el.diffBlock = document.getElementById("diffBlock");
    el.diff = document.getElementById("diff");
    el.version = document.getElementById("version");

    loadVersion();
});

let binaryB64 = "";
let decoded = "";
let view = "binary";

function setStatus(msg, cls) {
    if (!el.status) return;
    el.status.textContent = msg;
    el.status.className = "status " + cls;
}

function loadVersion() {
    fetch("/version")
        .then(r => r.json())
        .then(d => el.version.textContent = d.version);
}

function updateRepo() {
    if (!confirm("Update from GitHub?")) return;
    setStatus("Updating…", "working");

    fetch("/update_repo", { method: "POST" })
        .then(r => r.json())
        .then(d => {
            setStatus(d.error ? "Update failed" : "Updated ✔", d.error ? "error" : "success");
            loadVersion();
        });
}

function readEdid() {
    el.diffBlock.style.display = "none";
    setStatus("Reading EDID…", "working");

    fetch(`/read_and_compare_edid?port=${el.portSelect.value}`)
        .then(r => r.json())
        .then(d => {
            if (d.error) return setStatus(d.error, "error");

            binaryB64 = d.binary_b64;
            decoded = d.decoded;

            el.matchResult.textContent = d.match;
            el.toggleView.disabled = false;

            el.saveBtn.disabled = d.match !== "UNKNOWN";
            el.saveName.disabled = d.match !== "UNKNOWN";

            setBinaryView();
            setStatus("Read complete ✔", "success");
        });
}

function toggleView() {
    view === "binary" ? setDecodedView() : setBinaryView();
}

function setBinaryView() {
    view = "binary";
    el.toggleView.textContent = "View: Binary";

    const bin = atob(binaryB64);
    let out = "";
    for (let i = 0; i < bin.length; i++) {
        out += bin.charCodeAt(i).toString(16).padStart(2, "0") + " ";
        if ((i + 1) % 16 === 0) out += "\n";
    }
    el.preview.value = out;
}

function setDecodedView() {
    view = "decoded";
    el.toggleView.textContent = "View: Decoded";
    el.preview.value = decoded;
}

function saveEdid() {
    fetch("/save_edid", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            filename: el.saveName.value,
            binary: binaryB64
        })
    }).then(() => setStatus("Saved ✔", "success"));
}

function confirmWrite() {
    const f = el.writeSelect.value;
    if (!f) return alert("Select EDID");
    if (!confirm(`Write EDID '${f}' to port ${el.portSelect.value}?`)) return;
    writeEdid();
}

function writeEdid() {
    el.diffBlock.style.display = "none";
    setStatus("Writing EDID…", "working");

    fetch("/write_edid", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            filename: el.writeSelect.value,
            port: el.portSelect.value
        })
    })
    .then(r => r.json())
    .then(d => {
        if (d.error) return setStatus(d.error, "error");

        if (d.verified) {
            setStatus("Write + Verify ✔", "success");
            readEdid(); // auto refresh
        } else {
            setStatus("Verify FAILED", "warning");
            el.diff.textContent = d.diff || "";
            el.diffBlock.style.display = "block";
        }
    });
}

function resetEdid() {
    el.preview.value = "";
    el.matchResult.textContent = "—";
    el.toggleView.disabled = true;
    el.saveBtn.disabled = true;
    el.saveName.disabled = true;
    el.diffBlock.style.display = "none";
    setStatus("Idle", "idle");
}
</script>

</body>
</html>

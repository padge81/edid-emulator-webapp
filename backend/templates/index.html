@ -10,12 +10,10 @@
            color: #e0e0e0;
            font-family: Arial, Helvetica, sans-serif;
            margin: 0;
            padding: 10px;
            padding: 10px 10px 90px 10px;
        }

        h1, h2, h3 {
            margin: 10px 0;
        }
        h1, h2, h3 { margin: 10px 0; }

        button, select, input {
            font-size: 18px;
@ -31,9 +29,7 @@
            border: 2px solid #444;
        }

        button:active {
            background: #333;
        }
        button:active { background: #333; }

        select, input {
            background: #111;
@ -66,18 +62,48 @@
            background: #111;
        }

        .status {
        /* ===== FLOATING STATUS BAR ===== */
        #statusBar {
            position: fixed;
            bottom: 10px;
            left: 10px;
            right: 10px;
            z-index: 9999;

            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;

            font-size: 18px;
            padding: 12px;
            border-radius: 6px;
            margin-top: 8px;
            padding: 14px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.8);

            pointer-events: none;
            transition: opacity 0.3s ease, background 0.3s ease;
        }

        #spinner {
            width: 22px;
            height: 22px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .idle { background: #2c2c2c; }
        .working { background: #7f6a00; }
        .success { background: #006644; }
        .warning { background: #664400; }
        .error { background: #660000; }
        .idle    { background: #2c2c2c; opacity: 0.35; }
        .working { background: #7f6a00; opacity: 1; }
        .success { background: #006644; opacity: 1; }
        .warning { background: #664400; opacity: 1; }
        .error   { background: #660000; opacity: 1; }

        .danger {
            background: #8b0000;
@ -98,12 +124,10 @@
            font-size: 13px;
        }

        label {
            font-size: 18px;
            margin-right: 10px;
        }
        label { font-size: 18px; margin-right: 10px; }
    </style>
</head>

<body>

<h1>EDID Emulator</h1>
@ -156,19 +180,10 @@

<div class="card">
    <h2>USB Import / Export</h2>

    <div class="row">
        <button onclick="loadUsb()">Scan USB</button>
    </div>

    <button onclick="loadUsb()">Scan USB</button>
    <div id="usbArea"></div>
</div>

<div class="card">
    <h2>Status</h2>
    <div id="status" class="status idle">Idle</div>
</div>

<div class="card">
    <h2>Verification Diff</h2>
    <pre id="diff"></pre>
@ -182,181 +197,38 @@
    </div>
</div>

<!-- FLOATING STATUS -->
<div id="statusBar" class="idle">
    <div id="spinner"></div>
    <div id="statusText">Idle</div>
</div>

<script>
const el = {};
let binaryB64 = "";
let decoded = "";
let view = "binary";
let statusTimer = null;

window.addEventListener("DOMContentLoaded", () => {
    el.status = document.getElementById("status");
    el.preview = document.getElementById("preview");
    el.matchResult = document.getElementById("matchResult");
    el.toggleView = document.getElementById("toggleView");
    el.saveBtn = document.getElementById("saveBtn");
    el.saveName = document.getElementById("saveName");
    el.writeSelect = document.getElementById("writeSelect");
    el.portSelect = document.getElementById("portSelect");
    el.diff = document.getElementById("diff");
    el.version = document.getElementById("version");
    el.usbArea = document.getElementById("usbArea");

    loadVersion();
    el.statusBar = document.getElementById("statusBar");
    el.statusText = document.getElementById("statusText");
    el.spinner = document.getElementById("spinner");
});

/* ===== STATUS MANAGER ===== */
function setStatus(msg, cls) {
    el.status.textContent = msg;
    el.status.className = "status " + cls;
}
    clearTimeout(statusTimer);

function loadVersion() {
    fetch("/version").then(r => r.json()).then(d => el.version.textContent = d.version);
}

function updateRepo() {
    if (!confirm("Update from GitHub?")) return;
    setStatus("Updating…", "working");
    fetch("/update_repo", { method: "POST" })
        .then(() => {
            setStatus("Updated ✔", "success");
            loadVersion();
        });
}
    el.statusText.textContent = msg;
    el.statusBar.className = cls;

function readEdid() {
    setStatus("Reading EDID…", "working");
    fetch(`/read_and_compare_edid?port=${el.portSelect.value}`)
        .then(r => r.json())
        .then(d => {
            binaryB64 = d.binary_b64;
            decoded = d.decoded;
            el.matchResult.textContent = d.match;
            el.toggleView.disabled = false;
            el.saveBtn.disabled = d.match !== "UNKNOWN";
            el.saveName.disabled = d.match !== "UNKNOWN";
            setBinaryView();
            setStatus("Read complete ✔", "success");
        });
}
    el.spinner.style.display = (cls === "working") ? "block" : "none";

function toggleView() {
    view === "binary" ? setDecodedView() : setBinaryView();
}

function setBinaryView() {
    view = "binary";
    el.toggleView.textContent = "View: Binary";
    const bin = atob(binaryB64);
    let out = "";
    for (let i = 0; i < bin.length; i++) {
        out += bin.charCodeAt(i).toString(16).padStart(2, "0") + " ";
        if ((i + 1) % 16 === 0) out += "\n";
    // Auto-hide success after 3s
    if (cls === "success") {
        statusTimer = setTimeout(() => {
            el.statusText.textContent = "Idle";
            el.statusBar.className = "idle";
        }, 3000);
    }
    el.preview.value = out;
}

function setDecodedView() {
    view = "decoded";
    el.toggleView.textContent = "View: Decoded";
    el.preview.value = decoded;
}

function saveEdid() {
    fetch("/save_edid", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            filename: el.saveName.value,
            binary: binaryB64
        })
    }).then(() => setStatus("Saved ✔", "success"));
}

function confirmWrite() {
    const f = el.writeSelect.value;
    if (!f) return alert("Select EDID");
    if (!confirm(`Write '${f}' to port ${el.portSelect.value}?`)) return;
    writeEdid();
}

function writeEdid() {
    setStatus("Writing EDID…", "working");
    fetch("/write_edid", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            filename: el.writeSelect.value,
            port: el.portSelect.value
        })
    })
    .then(r => r.json())
    .then(d => {
        if (d.verified) {
            setStatus("Write + Verify ✔", "success");
        } else {
            setStatus("Verify FAILED", "warning");
            el.diff.textContent = d.diff || "";
        }
    });
}

function resetEdid() {
    el.preview.value = "";
    el.matchResult.textContent = "—";
    el.toggleView.disabled = true;
    el.saveBtn.disabled = true;
    el.saveName.disabled = true;
    el.diff.textContent = "";
    setStatus("Idle", "idle");
}

function loadUsb() {
    el.usbArea.innerHTML = "";
    fetch("/usb/status")
        .then(r => r.json())
        .then(drives => {
            drives.forEach(d => {
                const div = document.createElement("div");
                div.innerHTML = `
                    <h3>${d.name}</h3>
                    <button onclick="importUsb('${d.path}')">Import</button>
                    ${d.read_only ? "" : `<button onclick="exportUsb('${d.path}')">Export</button>`}
                `;
                el.usbArea.appendChild(div);
            });
        });
}

function importUsb(mount) {
    fetch(`/usb/scan?mount=${mount}`)
        .then(r => r.json())
        .then(files => {
            const names = files.filter(f => !f.exists).map(f => f.name);
            fetch("/usb/import", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ mount, files: names })
            }).then(() => setStatus("Import complete ✔", "success"));
        });
}

function exportUsb(mount) {
    const files = Array.from(el.writeSelect.options).map(o => o.value).filter(Boolean);
    fetch("/usb/export", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ mount, files })
    }).then(() => setStatus("Export complete ✔", "success"));
}

function confirmShutdown() {
    if (!confirm("Shutdown system?")) return;
    fetch("/shutdown", { method: "POST" });
}

function confirmReboot() {
    if (!confirm("Reboot system?")) return;
    fetch("/reboot", { method: "POST" });
}
</script>


<!DOCTYPE html>
<html>
<head>
    <title>EDID Emulator</title>
    <style>
        body { font-family: Arial; max-width: 960px; margin: auto; }
        textarea { width: 80%; height: 200px; }
        button, select, input { margin: 5px 5px 5px 0; }
        pre { background: #111; color: #0f0; padding: 10px; overflow-x: auto; }
		.space-around {padding-left: 20px;}
        .status { padding: 8px; font-weight: bold; border-radius: 4px; }
        .idle { background: #eee; }
        .working { background: #ffeaa7; }
        .success { background: #55efc4; }
        .warning { background: #fab1a0; }
        .error { background: #ff7675; }
		.container {padding: 0 40px; }
    margin: auto;
  }
    </style>
</head>
<body>

<div style="display:flex; justify-content:space-between;">
    <div>Version: <b id="version">loading…</b></div>
    <button onclick="updateRepo()">Update</button>
</div>

<hr>

<div class="space-around">
<h2>EDID Emulator</h2>
</div>

<label>I²C Port:</label>
<select id="portSelect">
    {% for p in ports %}
        <option value="{{ p }}" {% if p == default_port %}selected{% endif %}>{{ p }}</option>
    {% endfor %}
</select>

<div>
    <button onclick="readEdid()">Read EDID</button>
    <button onclick="resetEdid()">Reset</button>
    <button id="toggleView" onclick="toggleView()" >View: Binary</button>
</div>

<div class="container">
<p>Match: <b id="matchResult">—</b></p>
</div>

<textarea id="preview" readonly></textarea>

<h3>Save New EDID</h3>
<input id="saveName" placeholder="filename.bin" disabled>
<button id="saveBtn" onclick="saveEdid()" disabled>Save</button>

<h3>Write EDID</h3>
<select id="writeSelect">
    <option value="">-- select --</option>
    {% for f in files %}
        <option value="{{ f }}">{{ f }}</option>
    {% endfor %}
</select>
<button onclick="confirmWrite()">Write</button>

<h3>Status</h3>
<div id="status" class="status idle">Idle</div>

<div id="diffBlock" style="display:none;">
    <h3>Verification Diff</h3>
    <pre id="diff"></pre>
</div>

<script>
let binaryB64 = "", decoded = "", view = "binary";

function setStatus(msg, cls) {
    status.textContent = msg;
    status.className = "status " + cls;
}

function loadVersion() {
    fetch("/version").then(r => r.json())
        .then(d => version.textContent = d.version);
}

function updateRepo() {
    if (!confirm("Update from GitHub?")) return;
    setStatus("Updating…", "working");
    fetch("/update_repo", {method:"POST"})
        .then(r => r.json())
        .then(d => {
            setStatus(d.error ? "Update failed" : "Updated ✔", d.error ? "error" : "success");
            loadVersion();
        });
}

function readEdid() {
    diffBlock.style.display = "none";
    setStatus("Reading EDID…", "working");

    fetch(`/read_and_compare_edid?port=${portSelect.value}`)
        .then(r => r.json())
        .then(d => {
            if (d.error) return setStatus(d.error, "error");

            binaryB64 = d.binary_b64;
            decoded = d.decoded;
            matchResult.textContent = d.match;
            toggleView.disabled = false;

            saveBtn.disabled = d.match !== "UNKNOWN";
            saveName.disabled = d.match !== "UNKNOWN";

            setBinaryView();
            setStatus("Read complete ✔", "success");
        });
}

function toggleView() {
    view === "binary" ? setDecodedView() : setBinaryView();
}

function setBinaryView() {
    view = "binary";
    toggleView.textContent = "View: Binary";
    const bin = atob(binaryB64);
    let out = "";
    for (let i = 0; i < bin.length; i++) {
        out += bin.charCodeAt(i).toString(16).padStart(2, "0") + " ";
        if ((i + 1) % 16 === 0) out += "\n";
    }
    preview.value = out;
}

function setDecodedView() {
    view = "decoded";
    toggleView.textContent = "View: Decoded";
    preview.value = decoded;
}

function saveEdid() {
    fetch("/save_edid", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({filename:saveName.value, binary:binaryB64})
    }).then(() => setStatus("Saved ✔","success"));
}

function confirmWrite() {
    const f = writeSelect.value;
    if (!f) return alert("Select EDID");
    if (!confirm(`Write EDID '${f}' to port ${portSelect.value}?`)) return;
    writeEdid();
}

function writeEdid() {
    diffBlock.style.display = "none";
    setStatus("Writing EDID…", "working");

    fetch("/write_edid", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({filename:writeSelect.value, port:portSelect.value})
    })
    .then(r => r.json())
    .then(d => {
        if (d.error) return setStatus(d.error,"error");

        if (d.verified) {
            setStatus("Write + Verify ✔","success");
            readEdid();   // AUTO REFRESH
        } else {
            setStatus("Verify FAILED","warning");
            diff.textContent = d.diff || "";
            diffBlock.style.display = "block";
        }
    });
}

function resetEdid() {
    preview.value = "";
    matchResult.textContent = "—";
    toggleView.disabled = true;
    saveBtn.disabled = true;
    saveName.disabled = true;
    diffBlock.style.display = "none";
    setStatus("Idle","idle");
}

loadVersion();
</script>

</body>
</html>

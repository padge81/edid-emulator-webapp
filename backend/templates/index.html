<!DOCTYPE html>
<html>
<head>
    <title>EDID Emulator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #0b0b0b;
            color: #f0f0f0;
            margin: 0;
            padding: 10px;
        }

        h2, h3 {
            margin: 10px 0 6px 0;
        }

        hr {
            border: none;
            border-top: 1px solid #333;
            margin: 12px 0;
        }

        button, select, input {
            font-size: 18px;
            padding: 14px 18px;
            margin: 6px 4px 6px 0;
            border-radius: 6px;
            border: none;
        }

        button {
            background: #2c3e50;
            color: #ecf0f1;
        }

        button:active {
            background: #34495e;
        }

        .danger {
            background: #c0392b;
        }

        .danger:active {
            background: #e74c3c;
        }

        .secondary {
            background: #555;
        }

        select, input {
            background: #111;
            color: #f0f0f0;
            border: 1px solid #333;
        }

        textarea {
            width: 100%;
            height: 160px;
            font-family: monospace;
            font-size: 14px;
            background: #111;
            color: #0f0;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 8px;
        }

        .status {
            padding: 12px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 6px;
            margin-top: 10px;
            text-align: center;
        }

        .idle { background: #2d3436; }
        .working { background: #b2bec3; color: #000; }
        .success { background: #00b894; }
        .warning { background: #e17055; }
        .error { background: #d63031; }

        pre {
            background: #111;
            color: #f55;
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 14px;
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
        }

        .row > * {
            margin-right: 8px;
            margin-bottom: 6px;
        }

        .full {
            width: 100%;
        }

        small {
            color: #aaa;
        }
    </style>
</head>

<body>

<!-- Header -->
<div class="row" style="justify-content:space-between;">
    <div>
        <strong>EDID Emulator</strong><br>
        <small>Version: <b id="version">loading…</b></small>
    </div>
    <button onclick="updateRepo()">Update</button>
</div>

<hr>

<!-- Port selection -->
<label><strong>I²C Port:</strong></label>
<select id="portSelect" class="full">
    {% for p in ports %}
        <option value="{{ p }}" {% if p == default_port %}selected{% endif %}>{{ p }}</option>
    {% endfor %}
</select>

<hr>

<!-- EDID Controls -->
<div class="row">
    <button onclick="readEdid()">Read EDID</button>
    <button onclick="resetEdid()">Reset</button>
    <button id="toggleView" onclick="toggleView()" disabled>View: Binary</button>
</div>

<div>
    Match: <strong id="matchResult">—</strong>
</div>

<textarea id="preview" readonly></textarea>

<hr>

<!-- Save -->
<h3>Save New EDID</h3>
<input id="saveName" placeholder="filename.bin" class="full" disabled>
<button id="saveBtn" onclick="saveEdid()" disabled>Save</button>

<hr>

<!-- Write -->
<h3>Write EDID</h3>
<select id="writeSelect" class="full">
    <option value="">-- select --</option>
    {% for f in files %}
        <option value="{{ f }}">{{ f }}</option>
    {% endfor %}
</select>
<button onclick="confirmWrite()">Write</button>

<hr>

<!-- USB -->
<h3>USB</h3>
<div class="row">
    <button class="secondary" onclick="usbImport()">USB Import</button>
    <button class="secondary" onclick="usbExport()">USB Export</button>
</div>

<hr>

<!-- System -->
<h3>System</h3>
<div class="row">
    <button class="danger" onclick="rebootSystem()">Reboot</button>
    <button class="danger" onclick="shutdownSystem()">Shutdown</button>
</div>

<hr>

<!-- Status -->
<h3>Status</h3>
<div id="status" class="status idle">Idle</div>

<!-- Diff -->
<div id="diffBlock" style="display:none;">
    <h3>Verification Diff</h3>
    <pre id="diff"></pre>
</div>

<script>
const el = {};

window.addEventListener("DOMContentLoaded", () => {
    el.status = document.getElementById("status");
    el.preview = document.getElementById("preview");
    el.matchResult = document.getElementById("matchResult");
    el.toggleView = document.getElementById("toggleView");
    el.saveBtn = document.getElementById("saveBtn");
    el.saveName = document.getElementById("saveName");
    el.writeSelect = document.getElementById("writeSelect");
    el.portSelect = document.getElementById("portSelect");
    el.diffBlock = document.getElementById("diffBlock");
    el.diff = document.getElementById("diff");
    el.version = document.getElementById("version");

    loadVersion();
});

let binaryB64 = "";
let decoded = "";
let view = "binary";

function setStatus(msg, cls) {
    el.status.textContent = msg;
    el.status.className = "status " + cls;
}

/* ---------- existing logic unchanged ---------- */

function loadVersion() {
    fetch("/version")
        .then(r => r.json())
        .then(d => el.version.textContent = d.version);
}

function updateRepo() {
    if (!confirm("Update from GitHub?")) return;
    setStatus("Updating…", "working");

    fetch("/update_repo", { method: "POST" })
        .then(r => r.json())
        .then(d => {
            setStatus(d.error ? "Update failed" : "Updated ✔", d.error ? "error" : "success");
            loadVersion();
        });
}

function readEdid() {
    el.diffBlock.style.display = "none";
    setStatus("Reading EDID…", "working");

    fetch(`/read_and_compare_edid?port=${el.portSelect.value}`)
        .then(r => r.json())
        .then(d => {
            if (d.error) return setStatus(d.error, "error");

            binaryB64 = d.binary_b64;
            decoded = d.decoded;

            el.matchResult.textContent = d.match;
            el.toggleView.disabled = false;

            el.saveBtn.disabled = d.match !== "UNKNOWN";
            el.saveName.disabled = d.match !== "UNKNOWN";

            setBinaryView();
            setStatus("Read complete ✔", "success");
        });
}

function toggleView() {
    view === "binary" ? setDecodedView() : setBinaryView();
}

function setBinaryView() {
    view = "binary";
    el.toggleView.textContent = "View: Binary";

    const bin = atob(binaryB64);
    let out = "";
    for (let i = 0; i < bin.length; i++) {
        out += bin.charCodeAt(i).toString(16).padStart(2, "0") + " ";
        if ((i + 1) % 16 === 0) out += "\n";
    }
    el.preview.value = out;
}

function setDecodedView() {
    view = "decoded";
    el.toggleView.textContent = "View: Decoded";
    el.preview.value = decoded;
}

function saveEdid() {
    fetch("/save_edid", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            filename: el.saveName.value,
            binary: binaryB64
        })
    }).then(() => setStatus("Saved ✔", "success"));
}

function confirmWrite() {
    const f = el.writeSelect.value;
    if (!f) return alert("Select EDID");
    if (!confirm(`Write EDID '${f}' to port ${el.portSelect.value}?`)) return;
    writeEdid();
}

function writeEdid() {
    el.diffBlock.style.display = "none";
    setStatus("Writing EDID…", "working");

    fetch("/write_edid", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            filename: el.writeSelect.value,
            port: el.portSelect.value
        })
    })
    .then(r => r.json())
    .then(d => {
        if (d.error) return setStatus(d.error, "error");

        if (d.verified) {
            setStatus("Write + Verify ✔", "success");
            readEdid();
        } else {
            setStatus("Verify FAILED", "warning");
            el.diff.textContent = d.diff || "";
            el.diffBlock.style.display = "block";
        }
    });
}

function resetEdid() {
    el.preview.value = "";
    el.matchResult.textContent = "—";
    el.toggleView.disabled = true;
    el.saveBtn.disabled = true;
    el.saveName.disabled = true;
    el.diffBlock.style.display = "none";
    setStatus("Idle", "idle");
}

/* ---------- NEW USB + SYSTEM ---------- */

function usbImport() {
    if (!confirm("Import EDID files from USB?")) return;
    setStatus("Importing from USB…", "working");

    fetch("/usb/import", { method: "POST" })
        .then(r => r.json())
        .then(d => {
            if (d.error) setStatus(d.error, "error");
            else setStatus("USB Import complete ✔", "success");
        });
}

function usbExport() {
    if (!confirm("Export EDID files to USB?")) return;
    setStatus("Exporting to USB…", "working");

    fetch("/usb/export", { method: "POST" })
        .then(r => r.json())
        .then(d => {
            if (d.error) setStatus(d.error, "error");
            else setStatus("USB Export complete ✔", "success");
        });
}

function rebootSystem() {
    if (!confirm("Reboot system?")) return;
    fetch("/system/reboot", { method: "POST" });
}

function shutdownSystem() {
    if (!confirm("Shutdown system?")) return;
    fetch("/system/shutdown", { method: "POST" });
}
</script>

</body>
</html>

<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>EDID Emulator</title>
<style>
body { font-family: Arial; background:#111; color:#eee; padding:20px; }
button { font-size:18px; padding:14px; margin:8px; }
.status { padding:10px; margin-top:10px; border-radius:5px; }
.ok { background:#2e7d32; }
.warn { background:#f9a825; }
.err { background:#c62828; }
.modal {
  position:fixed; inset:0; background:rgba(0,0,0,.8);
  display:none; align-items:center; justify-content:center;
}
.modal > div {
  background:#222; padding:20px; max-width:600px; width:90%;
}
table { width:100%; border-collapse:collapse; }
td,th { padding:6px; border-bottom:1px solid #444; }
</style>
</head>

<body>

<h1>EDID Emulator</h1>

<button onclick="openImport()">Import from USB</button>
<button onclick="openExport()">Export to USB</button>
<button onclick="shutdown()">Shutdown</button>

<div id="status" class="status ok">Ready</div>

<!-- USB Modal -->
<div id="usbModal" class="modal">
  <div>
    <h3>Select USB</h3>
    <select id="usbSelect" style="width:100%;font-size:18px"></select>
    <br><br>
    <button onclick="confirmUSB()">Continue</button>
    <button onclick="closeModal()">Cancel</button>
  </div>
</div>

<!-- Import Preview -->
<div id="previewModal" class="modal">
  <div>
    <h3>Import Preview</h3>
    <table id="previewTable"></table>
    <br>
    <button onclick="doImport()">Import Selected</button>
    <button onclick="closeModal()">Cancel</button>
  </div>
</div>

<script>
const el = {
  status: document.getElementById("status"),
  usbModal: document.getElementById("usbModal"),
  previewModal: document.getElementById("previewModal"),
  usbSelect: document.getElementById("usbSelect"),
  previewTable: document.getElementById("previewTable")
};

let mode = "";
let usbPath = "";
let previewData = [];

function setStatus(msg, cls="ok") {
  el.status.textContent = msg;
  el.status.className = "status " + cls;
}

function closeModal() {
  el.usbModal.style.display = "none";
  el.previewModal.style.display = "none";
}

async function openImport() {
  mode = "import";
  await showUSBs();
}

async function openExport() {
  mode = "export";
  await showUSBs();
}

async function showUSBs() {
  const res = await fetch("/usb");
  const list = await res.json();
  el.usbSelect.innerHTML = list.map(p => `<option>${p}</option>`).join("");
  el.usbModal.style.display = "flex";
}

async function confirmUSB() {
  usbPath = el.usbSelect.value;
  closeModal();

  if (mode === "import") {
    const res = await fetch(`/usb_scan?path=${encodeURIComponent(usbPath)}`);
    previewData = await res.json();

    el.previewTable.innerHTML =
      "<tr><th>Name</th><th>Status</th></tr>" +
      previewData.map(f =>
        `<tr><td>${f.name}</td><td>${f.status}</td></tr>`
      ).join("");

    el.previewModal.style.display = "flex";
  } else {
    doExport();
  }
}

async function doImport() {
  closeModal();
  setStatus("Importing...", "warn");

  const files = previewData.filter(f => f.status === "new").map(f => f.name);

  const res = await fetch("/usb_import", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({path:usbPath, files})
  });

  const d = await res.json();
  setStatus(`Imported ${d.imported.length}, skipped ${d.skipped.length}`, "ok");
}

async function doExport() {
  setStatus("Exporting...", "warn");
  const res = await fetch("/usb_export", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({path:usbPath})
  });
  const d = await res.json();
  setStatus(`Exported ${d.exported.length}, skipped ${d.skipped.length}`, "ok");
}

async function shutdown() {
  if (!confirm("Shutdown system?")) return;
  setStatus("Shutting down...", "warn");
  await fetch("/shutdown", {method:"POST"});
}
</script>

</body>
</html>
